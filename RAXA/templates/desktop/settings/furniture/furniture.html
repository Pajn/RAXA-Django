{% load i18n %}
{% load url from future %}
<style type="text/css">
    #floor svg, #floorOverlay svg {
        position: absolute;
        top: 15%;
        left: 20px;
        max-height: 60%;
        max-width: 60%;
    }
</style>
{{ selectfloor }}
<input id="grid" type="checkbox" checked="checked" />
<label for="grid">{% blocktrans %}Snap to grid{% endblocktrans %}</label>
<div id="floor">
</div>
<div id="floorOverlay">
</div>
<div id="dialog-save" title="">
    <form action="{% url 'desktop.views.settings' type='furniture' %}" method="post">{% csrf_token %}
        {{ form.as_p }}
        <input type="submit" name="save" value="{% trans "Save" %}" />
    </form>
</div>
<script type="text/javascript">
    var x, y;
    function get_floor() {
        var floor = $('#selectfloor').val();
        $('input[name="floor"]').val(floor);
        $('#floor').load('{{ STATIC_URL }}images/floor'+floor+'.svg');
        $('#floorOverlay').load('{% url 'common.views.overlay' %}', {'floor': floor}, function() {

            var svgNamespace = 'http://www.w3.org/2000/svg';
            var $overlay = $('#floorOverlay svg');

            $overlay.on('click', function(e){
                var planGridX = 10;
                var planGridY = 10;
                var pt = this.createSVGPoint();

                pt.x = e.clientX; pt.y = e.clientY;
                var loc = pt.matrixTransform(this.getScreenCTM().inverse());

                if ($("#grid").attr('checked')) {
                    x = (Math.round(loc.x / planGridX) * planGridX);
                    y = (Math.round(loc.y / planGridY) * planGridY);
                } else {
                    x = Math.round(loc.x);
                    y = Math.round(loc.y);
                }
                $('input[name="x1"]').val(x);
                $('input[name="y1"]').val(y);
                if (document.getElementById("hover")) {
                    $('.hover').remove();
                }

                $('#dialog-save').dialog('open');
                e.stopPropagation();
                return false;
            });
            $overlay.on('mousemove', function(e){
                var planGridX = 10;
                var planGridY = 10;
                var pt = this.createSVGPoint();

                pt.x = e.clientX; pt.y = e.clientY;
                var loc = pt.matrixTransform(this.getScreenCTM().inverse());

                if ($("#grid").attr('checked')) {
                    x = (Math.round(loc.x / planGridX) * planGridX);
                    y = (Math.round(loc.y / planGridY) * planGridY);
                } else {
                    x = Math.round(loc.x);
                    y = Math.round(loc.y);
                }
                if (document.getElementById("hover")) {
                    $('.hover').remove();
                }
                var svg = e.target.ownerDocument.createElementNS(svgNamespace, 'circle');
                svg.setAttributeNS(null, 'id', 'hover');
                svg.setAttributeNS(null, 'class', 'hover');
                svg.setAttributeNS(null, 'cx', x + 'px');
                svg.setAttributeNS(null, 'cy', y + 'px');
                svg.setAttributeNS(null, 'r', '10px');
                svg.setAttributeNS(null, "fill", "rgba(0, 100, 0, 0.5)");
                svg.setAttributeNS(null, "pointer-events", "none");
                this.appendChild(svg);
            });
            $overlay.mouseout(function(e){
                if (document.getElementById("hover")) {
                    $('.hover').remove();
                }
            });
            $("#floorOverlay svg .dot").on('contextmenu', function(e) {
                $.post('{% url 'desktop.views.settings' type='furniture' %}', {'id': this.id});
                this.parentNode.removeChild(this);
                update_overlay();
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        });
    }
    $(function() {
        get_floor();
        $('#selectfloor').change(get_floor);
        $('#dialog-save').dialog({
            modal: true,
            autoOpen: false
        });
    });
</script>